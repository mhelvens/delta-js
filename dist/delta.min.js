!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e(require("js-graph")):"function"==typeof define&&define.amd?define(["js-graph"],e):"object"==typeof exports?exports.DeltaJs=e(require("js-graph")):t.DeltaJs=e(t.JsGraph)}(this,function(t){return function(t){function e(o){if(n[o])return n[o].exports;var r=n[o]={exports:{},id:o,loaded:!1};return t[o].call(r.exports,r,r.exports,e),r.loaded=!0,r.exports}var n={};return e.m=t,e.c=n,e.p="",e(0)}([function(t,e,n){var o,r;o=[n(2),n(1)],r=function(t,e){"use strict";function n(t,e){return new a(t,e)}var o=t.newClass(function(){var e=this,o=this;this.operations={},this.compositions=[],this._onNewOperationTypeListeners=[];var a=1,s=this.Delta=t.newClass(function(e,n){this.arg=e,this.meta=t.extend({},n||{},{uuid:a++})},{clone:function(){return new this.constructor(this.arg,this.meta)},appliedTo:function(t){t instanceof i&&(t=t.value),"function"==typeof t.clone&&(t=t.clone());var e={value:t};return this.applyTo(n(e,"value")),e.value},composedWith:function(t){return o.composed(this,t)},toString:function(){var e=void 0!==arguments[0]?arguments[0]:{},n=this.type;return this.meta.targetProp&&(n+=" ‹"+this.meta.targetProp+"›"),t.isDefined(this.arg)&&(n+=": "+JSON.stringify(this.arg)),e.debug&&(n+=" ("+this.meta.uuid+")"),n}}),c=this.operations.CompositeDelta=t.newSubclass(s,{operation:function(){throw new Error("A CompositeDelta subclass needs to implement the 'operation' method.")}});!function(){var n={};e.onNewOperationType(function(e){(e.meta&&e.meta.methods||[]).forEach(function(e){t.isUndefined(n[e])&&(n[e]=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];var r=this._applyOperationMethod.apply(this,[e].concat(t));return o.facade(r instanceof c?r:this.delta)})})}),e.facade=function r(e){var o=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];var i=r(e);return i._args=o._args.concat(t),i};return o._args=[],t.extend(o,n,{_applyOperationMethod:function(t){for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];return e.operation.apply(e,[t].concat(o._args).concat(n))},delta:e}),o}}(),c.prototype.facade=function(){return o.facade(this)},this.overloads={};var l=this.operations.OverloadedDelta=t.newSubclass(this.Delta,function(t){return function(e,n){t.call(this,e,n),this.overloads=[]}},{clone:function(){var t=o.Delta.prototype.clone.call(this,this.arg,this.meta);return t.overloads=this.overloads.map(function(t){return t.clone()}),t},applyTo:function(t){var e=[],n=this.overloads.some(function(n){var r=o._evaluatePrecondition(n,t);return r!==!0?(e.push(r),!1):(n.applyTo(t),!0)});if(!n)throw 0===e.length?new p(this,t.value):1===e.length?e[0]:new u(this,t.value,e)},toString:function(e){var n=s.prototype.toString.call(this,e),o=this.overloads.map(function(t){return t.toString(e)}).join("\n");return n+="\n"+t.indent(o,4)}});l.type=l.prototype.type="OverloadedDelta",l.meta=l.prototype.meta={methods:[]},this.newComposition(function(t,e){return t instanceof l||e instanceof l},function(t,e){var n=t instanceof l?t.overloads:[t],o=e instanceof l?e.overloads:[e],r=new l,i=[];if(n.forEach(function(t){o.forEach(function(e){try{r.overloads.push(t.composedWith(e))}catch(n){i.push(n)}})}),0===r.overloads.length)throw new h(t,e,i);return r});var f=this.operations.Modify=t.newSubclass(c,function(t){return function(e,n){t.call(this,e,n),this.deltas={}}},{clone:function(){var t=this,e=o.Delta.prototype.clone.call(this,this.arg,this.meta);return Object.keys(this.deltas).forEach(function(n){e.deltas[n]=t.deltas[n].clone()}),e},precondition:function(t){return t.value instanceof Object},applyTo:function(t){var e=this;Object.keys(this.deltas).forEach(function(o){e.deltas[o].applyTo(n(t.value,o))})},toString:function(e){var n=this,o=s.prototype.toString.call(this,e);if(Object.keys(this.deltas).length>0){var r=Object.keys(this.deltas).map(function(t){return n.deltas[t].toString(e)}).join("\n");o+="\n"+t.indent(r,4)}return o},operation:function(t,e,n,i){var a;"string"==typeof e&&(a=[{},e,n],e=a[0],n=a[1],i=a[2],a);var s=o._getDeltaByMethod(t,i);return this._addOperation(e,new r(n),s)},_addOperation:function(t,e,n){return e.rest?this.operation("modify",e.prop)._addOperation(t,e.rest,n):(this.deltas[e.prop]=this.deltas[e.prop]?this.deltas[e.prop].composedWith(n):n,this.deltas[e.prop].meta.targetProp=e.prop,this.deltas[e.prop]instanceof c?this.deltas[e.prop]:n)}});f.type=f.prototype.type="Modify",f.meta=f.prototype.meta={methods:["modify"]},this._onNewOperationTypeListeners.forEach(function(t){t(f)}),Array.isArray(this.overloads.modify)||(this.overloads.modify=[]),this.overloads.modify.push("Modify"),this._defineStandardOperationTypes()},{_getDeltaByMethod:function(t,e){var n=this,o=this.overloads[t].map(function(o){return new n.operations[o](e,{method:t})});if(1===o.length)return o[0];var r=new this.operations.OverloadedDelta(e,{method:t});return r.overloads=o,r},_evaluatePrecondition:function(t,e){if("function"==typeof t.precondition){var n=t.precondition(e);if(n instanceof Error)return n;if(!n)return new s(t,e.value)}return!0},newOperationType:function(e,n,o){var r,i=this;"string"==typeof e&&(r=[void 0,e,n],e=r[0],n=r[1],o=r[2],r),o=o||{};var a=this;t.assert(!this.operations[n],"The '"+n+"' operation type already exists.");var s=this.operations[n]=t.newSubclass(e||this.Delta,function(t){return function(e,n){t.call(this,e,n),this.construct&&this.construct()}},t.extend({},o,{applyTo:function(e){var n=a._evaluatePrecondition(this,e);if(n!==!0)throw n;t.isDefined(o.applyTo)&&o.applyTo.call(this,e)}}));return s.type=s.prototype.type=n,s.meta=s.prototype.meta={methods:o.methods||[n[0].toLowerCase()+n.slice(1)]},s.meta.methods.forEach(function(t){Array.isArray(i.overloads[t])||(i.overloads[t]=[]),i.overloads[t].push(n)}),this._onNewOperationTypeListeners.forEach(function(t){t(s)}),s},onNewOperationType:function(t){var e=this;this._onNewOperationTypeListeners.push(t),Object.keys(this.operations).forEach(function(n){t(e.operations[n])})},newComposition:function(t,e){this.compositions.push({precondition:t,compose:e})},composed:function(e,n){t.isUndefined(e)&&(e=new this.operations.NoOp),t.isUndefined(n)&&(n=new this.operations.NoOp);var o=function(){},r=this.compositions.some(function(t){var r=t,i=r.precondition,a=r.compose;return i(e,n)?(o=a,!0):void 0});if(!r)throw new l(e,n);return o(e,n)},_defineStandardOperationTypes:function(){function o(t,e){return function(n,o){return n.type===t&&o.type===e}}function i(t,e){return"string"==typeof e&&(e=function(t){return function(e){return e[t]}}(e)),function(n,o){return new s.operations[t](e&&e({d1:n,d2:o,p1:n.arg,p2:o.arg}))}}var s=this,u=this.newOperationType("NoOp");this.newComposition(function(t){return t instanceof u},function(t,e){return e.clone()}),this.newComposition(function(t,e){return e instanceof u},function(t){return t.clone()}),[["Add","add",function(e){return t.isUndefined(e.value)}],["Replace","replace",function(e){return t.isDefined(e.value)}]].forEach(function(e){var o=e,r=o[0],i=(o[1],o[2]);s.newOperationType(r,{construct:function(){this.deltasToApplyToArg=[]},precondition:function(t){return t instanceof a&&i(t)},applyTo:function(t){t.value=this.deltasToApplyToArg.reduce(function(t,e){return e.appliedTo(t)},this.arg)},clone:function(){var t=s.Delta.prototype.clone.call(this,this.arg,this.meta);return t.deltasToApplyToArg=this.deltasToApplyToArg.map(function(t){return t}),t},afterApplying:function(t){var e=this.clone();if(e.deltasToApplyToArg.push(t),e.deltasToApplyToArg.reduce(function(t,e){return s.composed(t,e)}).precondition(n(e,"arg"))!==!0)throw new c(t,this);return e},toString:function(e){var n=this,o=s.Delta.prototype.toString.call(this,e);if(Object.keys(this.deltasToApplyToArg).length>0){var r=Object.keys(this.deltasToApplyToArg).map(function(t){return n.deltasToApplyToArg[t].toString(e)}).join("\n");o+="\n"+t.indent(r,4)}return o}})}),this.newOperationType("Remove",{precondition:function(e){return e instanceof a&&t.isDefined(e.value)},applyTo:function(t){t.delete()}}),this.newOperationType("Forbid",{precondition:function(e){return t.isUndefined(e.value)}}),this.newComposition(o("Modify","Modify"),function(t,e){var n=t.clone();return Object.keys(e.deltas).forEach(function(t){n.deltas[t]=s.composed(n.deltas[t],e.deltas[t])}),n}),this.newComposition(o("Add","Modify"),function(t,e){return t.afterApplying(e)}),this.newComposition(o("Modify","Remove"),i("Remove")),this.newComposition(o("Add","Remove"),i("Forbid")),this.newComposition(o("Remove","Add"),i("Replace",function(t){var e=t.p2;return e})),this.newComposition(o("Remove","Forbid"),i("Remove")),this.newComposition(o("Forbid","Add"),i("Add",function(t){var e=t.p2;return e})),this.newComposition(o("Forbid","Forbid"),i("Forbid")),this.newComposition(o("Modify","Replace"),i("Replace",function(t){var e=t.p2;return e})),this.newComposition(o("Add","Replace"),i("Add",function(t){var e=t.p2;return e})),this.newComposition(o("Replace","Modify"),function(t,e){return t.afterApplying(e)}),this.newComposition(o("Replace","Remove"),i("Remove")),this.newComposition(o("Replace","Replace"),i("Replace",function(t){var e=t.p2;return e})),this.newOperationType("PutIntoArray",{construct:function(){this.values=this.meta.method?[{method:this.meta.method,value:this.arg}]:[]},clone:function(){var t=s.Delta.prototype.clone.call(this,this.arg,this.meta);return t.values=[],this.values.forEach(function(e){t.values.push(e)}),t},precondition:function(e){return t.isDefined(e.value)&&Array.isArray(e.value)},applyTo:function(t){var e=t.value;this.values.forEach(function(t){var n=t,o=n.method,r=n.value;switch(o){case"prepend":e.unshift(r);break;case"insert":var i=Math.floor(Math.random()*(e.length+1));e.splice(i,0,r);break;case"append":e.push(r)}})},methods:["prepend","insert","append"]}),this.newComposition(o("Add","PutIntoArray"),function(t,e){return t.afterApplying(e)}),this.newComposition(o("Replace","PutIntoArray"),function(t,e){return t.afterApplying(e)}),this.newComposition(o("PutIntoArray","Remove"),i("Remove")),this.newComposition(o("PutIntoArray","Replace"),i("Replace",function(t){var e=t.p2;return e})),this.newComposition(o("PutIntoArray","PutIntoArray"),function(t,e){var n=new s.operations.PutIntoArray;return n.values=t.values.concat(e.values),n}),this.newOperationType("PutIntoFunction",{construct:function(){this.values=this.meta.method?[{method:this.meta.method,value:this.arg}]:[]},clone:function(){var t=s.Delta.prototype.clone.call(this,this.arg,this.meta);return t.values=[],this.values.forEach(function(e){t.values.push(e)}),t},precondition:function(e){return t.isDefined(e.value)&&"function"==typeof e.value&&(t.isDefined(e.value._DeltaJs_functions)||e instanceof a)},applyTo:function(e){if(t.isUndefined(e.value._DeltaJs_functions)){var n=e.value,o=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n,r=this;return o._DeltaJs_functions.forEach(function(e){n=e.apply(r,t)}),n};o._DeltaJs_functions=[function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];n.apply(this,t)}],e.value=o}var r=e.value._DeltaJs_functions;this.values.forEach(function(t){var e=t,n=e.method,o=e.value;switch(n){case"prepend":r.unshift(o);break;case"insert":var i=Math.floor(Math.random()*(r.length+1));r.splice(i,0,o);break;case"append":r.push(o)}})},methods:["prepend","insert","append"]}),this.newComposition(o("Add","PutIntoFunction"),function(t,e){return t.afterApplying(e)}),this.newComposition(o("Replace","PutIntoFunction"),function(t,e){return t.afterApplying(e)}),this.newComposition(o("PutIntoFunction","Remove"),i("Remove")),this.newComposition(o("PutIntoFunction","Replace"),i("Replace",function(t){var e=t.p2;return e})),this.newComposition(o("PutIntoFunction","PutIntoFunction"),function(t,e){var n=new s.operations.PutIntoFunction;return n.values=t.values.concat(e.values),n});var p=this.newOperationType(this.operations.CompositeDelta,"DeltaModel",{construct:function(){this.graph=new e},clone:function(){var t=new p;return t.graph=this.graph.clone(),t.graph.eachVertex(function(e,n){t.graph.setVertex(e,n.clone())}),t},applyTo:function(t){this.graph.topologically(function(e,n){n.applyTo(t)})},operation:function(t,e,n,o,i){var a;"string"==typeof n&&(a=[{},n,o],n=a[0],o=a[1],i=a[2],a);var u=s._getDeltaByMethod(t,i);return this._addOperation(e,n,new r(o),u)},toString:function(e){var n=s.Delta.prototype.toString.call(this,e);if(this.graph.vertexCount()>0){var o="";this.graph.topologically(function(t,n){o+="["+t+"] "+n.toString(e)+"\n"}),n+="\n"+t.indent(o,4)}return n},_addOperation:function(e,n,o,r){var i=this,a=n.before,u=r;return o.prop&&(u=new s.operations.Modify,u._addOperation(n,o,r)),t.assert(!this.graph.vertexValue(e),"A delta by the name “"+e+"” is already in this delta model."),this.graph.addVertex(e,u),(a||[]).forEach(function(t){i.graph.createEdge(t,e)}),r}});this.newComposition(function(t,e){return t instanceof p||e instanceof p},function(t,e){var n=new p;return n.graph.addNewVertex(1,t),n.graph.addNewVertex(2,e),n.graph.addNewEdge(1,2),n})}}),r=o.Path=t.newClass(function(){var e=void 0!==arguments[0]?arguments[0]:"",n=e.match(/^([.#]?)(\w*|\(\w+\))(.*)$/);t.assert(n,"The path string '"+e+"' is not well formed.");var o=n,i=o[1],a=o[2],s=o[3];"#"===i?this.set(new r(".(instance)."+a+s)):""!==a&&(this._prop=a,""!==s&&(this._rest=new r(s)))},{set:function(t){this._prop=t._prop,this._rest=t._rest},get prop(){return this._prop},get rest(){return this._rest}}),i=o.ReadableTarget=t.newClass(function(t){this._val=t},{getValue:function(){return this._val},get value(){return this.getValue()},set value(t){this.setValue(t)},chain:function(e){return t.assert(this.value instanceof Object,"The ReadableTarget.prototype.chain method expects the target value to be an Object."),new a(this.value,e)}}),a=o.WritableTarget=t.newSubclass(i,function(){return function(t,e){this._obj=t,this._prop=e}},{getValue:function(){return this._obj[this._prop]},setValue:function(t){this._obj[this._prop]=t},"delete":function(){delete this._obj[this._prop]}}),s=o.ApplicationError=t.newSubclass(Error,function(t){return function(e,n){t.call(this,"This delta of type '"+e.type+"' cannot apply to this value of type '"+typeof n+"."),this.delta=e,this.value=n}}),u=o.MultipleOverloadsApplicationError=t.newSubclass(s,function(t){return function(e,n){var o=void 0!==arguments[2]?arguments[2]:[];t.call(this,e,n),this.errors=o,this.message="None of these deltas of types "+e.overloads.map(function(t){return"'"+t.type+"'"}).join(",")+" can apply to this value of type '"+typeof n+"."+o.map(function(t){return"\n-- "+t.message}).join("")}}),p=o.NoOverloadsApplicationError=t.newSubclass(s,function(t){return function(e,n){t.call(this,e,n),this.message="This delta of type '"+e.type+"' has no spcific deltas assigned to it, so it cannot apply to this value of type '"+typeof n+"."}}),c=o.DeltaArgApplicationError=t.newSubclass(s,function(t){return function(e,n){t.call(this,e,n.arg),this.message="This delta of type '"+e.type+"' cannot apply to the type-'"+typeof n.arg+"'-value of this base delta of type '"+n.type+"'.",this.baseDelta=n}}),l=o.CompositionError=t.newSubclass(Error,function(t){return function(e,n){t.call(this,"This delta of type '"+e.type+"' cannot be composed with this other delta of type '"+n.type+"."),this.delta1=e,this.delta2=n}}),h=o.MultipleOverloadsCompositionError=t.newSubclass(l,function(t){return function(e,n){var o=void 0!==arguments[2]?arguments[2]:[];t.call(this,e,n),this.errors=o,this.message="There are no overloads to compose this delta of type '"+e.type+"' with this other delta of type '"+n.type+"'."+o.map(function(t){return"\n-- "+t.message}).join("")}});return o}.apply(e,o),!(void 0!==r&&(t.exports=r))},function(e){e.exports=t},function(t,e,n){var o;o=function(){"use strict";var t={newClass:function(){var t=void 0!==arguments[0]?arguments[0]:{},e=void 0!==arguments[1]?arguments[1]:{};"function"!=typeof t&&(e=t,t=function(){});var n=t;return n.prototype=e,n.prototype.constructor=n,n},newSubclass:function(e){var n=void 0!==arguments[1]?arguments[1]:{},o=void 0!==arguments[2]?arguments[2]:{};"function"!=typeof n&&(o=n,n=function(t){return function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];t.apply(this,e)}});var r=n(e.prototype.constructor);return r.prototype=Object.create(e.prototype),t.extend(r.prototype,o),r.prototype.constructor=r,r},extend:function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];return e.forEach(function(e){for(var n in e)e.hasOwnProperty(n)&&Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(e,n))}),t},applyConstructor:function(t,e){var n=Object.create(t.prototype);return t.apply(n,e),n},assert:function(t,e){if(!t)throw new Error(e||"Assertion failed")},isUndefined:function(t){return"undefined"==typeof t},isDefined:function(t){return"undefined"!=typeof t},repeat:function(t,e){return new Array(t+1).join(e)},indent:function(e,n){var o=void 0!==arguments[2]?arguments[2]:" ";return e.replace(/^(?!\s*$)/gm,t.repeat(n,o))}};return t}.call(e,n,e,t),!(void 0!==o&&(t.exports=o))}])});