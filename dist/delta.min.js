!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e(require("js-graph")):"function"==typeof define&&define.amd?define(["js-graph"],e):"object"==typeof exports?exports.DeltaJs=e(require("js-graph")):t.DeltaJs=e(t.JsGraph)}(this,function(t){return function(t){function e(i){if(o[i])return o[i].exports;var n=o[i]={exports:{},id:i,loaded:!1};return t[i].call(n.exports,n,n.exports,e),n.loaded=!0,n.exports}var o={};return e.m=t,e.c=o,e.p="",e(0)}([function(t,e,o){var i,n;i=[o(2),o(1)],n=function(t){"use strict";function e(t,e){return new o.WritableField(t,e)}var o=t.newClass(function(){var o=this;this.operations={},this.compositions={},this.operations.Delta=t.newClass(function(t,e){this.arg=t,this.meta=e||{}},{clone:function(){return new this.constructor(this.arg,this.meta)},compose:function(e){var i=o.compositions[this.type][e.type];return t.assert(i.length>0,"No composition is defined between '"+this.type+"' and '"+e.type+"'."),i[0](this,e)},toString:function(){var e=void 0!==arguments[0]?arguments[0]:0,o=void 0!==arguments[1]?arguments[1]:"(root)",i=this,n=t.repeat(0+e,"    "),s=""+n+this.type+" '"+o+"'";return t.isDefined(this.arg)&&(s+=": "+JSON.stringify(this.arg).slice(1,-1)),this.deltas&&Object.keys(this.deltas).length>0&&(s+="\n"+Object.keys(this.deltas).map(function(t){return i.deltas[t].toString(e+1,t)}).join("\n")),s}}),this.operations.Modify=t.newSubclass(this.operations.Delta,function(t){return function(e,o){t.call(this,e,o),this.deltas={}}},{get type(){return"Modify"},clone:function(){var t=this,e=o.operations.Delta.prototype.clone.call(this,this.arg,this.meta);return Object.keys(this.deltas).forEach(function(o){e.deltas[o]=t.deltas[o].clone()}),e},applyTo:function(o){var i=this;t.assert(o.value instanceof Object,"The 'Modify' operation expects the property to be an already defined Object."),Object.keys(this.deltas).forEach(function(t){i.deltas[t].applyTo(e(o.value,t))})},applyToPropertiesOf:function(o){var i=this;t.assert(o instanceof Object,"The 'Modify' operation expects the property to be an already defined Object."),Object.keys(this.deltas).forEach(function(t){i.deltas[t].applyTo(e(o,t))})},modify:function(t){return this._addOperation("Modify",t)},_preProcessNewOperation:function(e,o,i,n){var s=o.match(/^([.#]?)(\w+|\(\w+\))(.*)$/);t.assert(s,"The path string '"+o+"' is not well formed.");var r=s,a=r[1],p=r[2],c=r[3],u=null;return"#"===a?u=this._addOperation(e,".(instance)."+p+c,i,n):c.length>0&&(u=this.modify(p)._addOperation(e,c,i,n)),{prop:p,result:u}},_addOperation:function(t,e,i,n){var s=this._preProcessNewOperation(t,e,i,n),r=s.prop,a=s.result;if(a)return a;var p=new o.operations[t](i,n);if(this.deltas[r]){var c=this.deltas[r]=this.deltas[r].compose(p);return"Modify"===t&&"Modify"!==c.type?new o.operations.TargetedModify(c.arg,n):"Modify"===c.type?c:this}return this.deltas[r]=p,"Modify"===p.type?p:this}}),this.operations.TargetedModify=t.newSubclass(this.operations.Modify,function(t){return function(e,o,i){t.call(this,o,i),this.target=e}},{clone:function(){var t=this.operations.Modify.prototype.clone.call(this,this.arg,this.meta);return t.target=this.target,t},applyTo:function(){throw new Error("TargetedModify deltas cannot be applied TO anything.")},_addOperation:function(t,i,n,s){var r=this._preProcessNewOperation(t,i,n,s),a=r.prop,p=r.result;if(p)return p;if("Modify"===t){var c=new o.operations.TargetedModify(n,s);return c.target=this.target[a],c}return new o.operations[t](n,s).applyTo(e(this.target,a)),this}}),this.compositions.Modify={Modify:[]},this._defineStandardOperationTypes()},{get Delta(){return this.operations.Modify},newOperationType:function(e,o){var i=o,n=i.construct,s=i.applyTo,r=i.methods,a=i.clone,p=this;t.assert(!this.operations[e],"The '"+e+"' operation type already exists."),r=r||[e[0].toLowerCase()+e.slice(1)],r.forEach(function(t){p.operations.Modify.prototype[t]=function(o,i){return this._addOperation(e,o,i,{method:t})}}),this.compositions[e]={},Object.keys(this.compositions).forEach(function(o){t.assert(!p.compositions[o][e]),t.assert(!p.compositions[e][o]),p.compositions[o][e]=[],p.compositions[e][o]=[]}),this.operations[e]=t.newSubclass(this.operations.Delta,function(t){return function(e,o){t.call(this,e,o),n&&n.call(this)}},t.extend({type:e,applyTo:s})),t.isDefined(a)&&(this.operations[e].prototype.clone=a)},newComposition:function(t,e,o){this.compositions[t][e].push(o)},_defineStandardOperationTypes:function(){function o(t,e){throw new Error("You cannot follow '"+t.type+"' with '"+e.type+"'.")}function i(t){var e=void 0!==arguments[1]?arguments[1]:function(){return null};return"string"==typeof e&&(e=function(t){return function(e){return e[t]}}(e)),function(o,i){return new c.operations[t](e({d1:o,d2:i,p1:o.arg,p2:i.arg}))}}function n(t){var e=t.p2;return e}function s(t,o){var i=t.clone();return o.applyTo(e(i,"arg")),i}function r(e,o){t.assert(t.isDefined(e),"The operation '"+o+"' expects the property to be defined.")}function a(e,o){t.assert(t.isUndefined(e),"The operation '"+o+"' expects the property to be undefined.")}function p(e,o){t.assert(Array.isArray(e),"The operation '"+o+"' expects the property to be an array.")}var c=this;this.newOperationType("Add",{applyTo:function(t){a(t.value,"Add"),t.value=this.arg}}),this.newOperationType("Remove",{applyTo:function(t){r(t.value,"Remove"),t.delete()}}),this.newOperationType("Forbid",{applyTo:function(t){a(t.value,"Forbid")}}),this.newOperationType("Replace",{applyTo:function(t){r(t.value,"Replace"),t.value=this.arg}}),this.newComposition("Modify","Modify",function(t,e){var o=t.clone();return Object.keys(e.deltas).forEach(function(t){o.deltas[t].compose(e.deltas[t])}),o}),this.newComposition("Modify","Add",o),this.newComposition("Add","Add",o),this.newComposition("Add","Modify",s),this.newComposition("Modify","Remove",i("Remove")),this.newComposition("Add","Remove",i("Forbid")),this.newComposition("Remove","Modify",o),this.newComposition("Remove","Add",i("Replace",n)),this.newComposition("Remove","Remove",o),this.newComposition("Modify","Forbid",o),this.newComposition("Add","Forbid",o),this.newComposition("Remove","Forbid",i("Remove")),this.newComposition("Forbid","Modify",o),this.newComposition("Forbid","Add",i("Add",n)),this.newComposition("Forbid","Remove",o),this.newComposition("Forbid","Forbid",i("Forbid")),this.newComposition("Modify","Replace",i("Replace",n)),this.newComposition("Add","Replace",i("Add",n)),this.newComposition("Remove","Replace",o),this.newComposition("Forbid","Replace",o),this.newComposition("Replace","Modify",s),this.newComposition("Replace","Add",o),this.newComposition("Replace","Remove",i("Remove")),this.newComposition("Replace","Forbid",o),this.newComposition("Replace","Replace",i("Replace",n)),this.newOperationType("Put",{construct:function(){this.values=this.meta.method?[{method:this.meta.method,value:this.arg}]:[]},clone:function(){var t=c.operations.Delta.prototype.clone.call(this,this.arg,this.meta);return t.values=[],this.values.forEach(function(e){t.values.push(e)}),t},applyTo:function(t){r(t.value,"Put"),p(t.value,"Put");var e=t.value;this.values.forEach(function(t){var o=t,i=o.method,n=o.value;switch(i){case"prepend":e.unshift(n);break;case"insert":var s=Math.floor(Math.random()*(e.length+1));e.splice(s,0,n);break;case"append":e.push(n)}})},methods:["prepend","insert","append"]}),this.newComposition("Modify","Put",o),this.newComposition("Add","Put",s),this.newComposition("Remove","Put",o),this.newComposition("Forbid","Put",o),this.newComposition("Replace","Put",s),this.newComposition("Put","Modify",o),this.newComposition("Put","Add",o),this.newComposition("Put","Remove",i("Remove")),this.newComposition("Put","Forbid",o),this.newComposition("Put","Replace",i("Replace",n)),this.newComposition("Put","Put",function(t,e){var o=new c.operations.Put;return o.values=t.values.concat(e.values),o})}});return o.WritableField=t.newClass(function(t,e){this.obj=t,this.prop=e},{get value(){return this.obj[this.prop]},set value(t){this.obj[this.prop]=t},"delete":function(){delete this.obj[this.prop]}}),o}.apply(e,i),!(void 0!==n&&(t.exports=n))},function(e){e.exports=t},function(t,e,o){var i;i=function(){"use strict";var t={newClass:function(t){var e=void 0!==arguments[1]?arguments[1]:{},o=t;return o.prototype=e,o.prototype.constructor=o,o},newSubclass:function(e,o){var i=void 0!==arguments[2]?arguments[2]:{},n=o(e.prototype.constructor);return n.prototype=Object.create(e.prototype),t.extend(n.prototype,i),n.prototype.constructor=n,n},extend:function(t){for(var e=[],o=1;o<arguments.length;o++)e[o-1]=arguments[o];return e.forEach(function(e){for(var o in e)e.hasOwnProperty(o)&&Object.defineProperty(t,o,Object.getOwnPropertyDescriptor(e,o))}),t},applyConstructor:function(t,e){var o=Object.create(t.prototype);return t.apply(o,e),o},assert:function(t,e){if(!t)throw new Error(e||"Assertion failed")},isUndefined:function(t){return"undefined"==typeof t},isDefined:function(t){return"undefined"!=typeof t},repeat:function(t,e){return new Array(t+1).join(e)}};return t}.call(e,o,e,t),!(void 0!==i&&(t.exports=i))}])});