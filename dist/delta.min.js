!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):"object"==typeof exports?exports.DeltaJs=e():t.DeltaJs=e()}(this,function(){return function(t){function e(n){if(o[n])return o[n].exports;var i=o[n]={exports:{},id:n,loaded:!1};return t[n].call(i.exports,i,i.exports,e),i.loaded=!0,i.exports}var o={};return e.m=t,e.c=o,e.p="",e(0)}([function(t,e,o){var n,i;n=[o(1)],i=function(t){"use strict";var e=t.newClass(function(){var e=this;this.operations={},this.compositions={},this.operations.Delta=t.newClass(function(){}),this.compositions.modify={modify:[]},this.operations.modify=t.newSubclass(this.operations.Delta,function(t){return function(){t(),this.deltas={}}},{type:"modify",applyTo:function(e,o){var n=this;t.isDefined(o)&&(e=e[o]),t.assert(e instanceof Object,"The 'modify' operation expects the property to be an already defined Object."),Object.keys(this.deltas).forEach(function(t){n.deltas[t].applyTo(e,t)})},appliedTo:function(e,o){t.isDefined(o)&&(e=e[o]);var n=t.extend({},e);return this.applyTo(n),n},compose:function(o,n){var i=this;if(n){var r=this.deltas[o],s=e.compositions[r.type][n.type].some(function(t){try{return t(i,o,n),!0}catch(e){}return!1});t.assert(s,"No composition is defined between '"+r.type+"' and '"+n.type+"'.")}return this},modify:function(t){return this._addOperation("modify",t,[])},_addOperation:function(o,n,i){var r=this,s=n.match(/^([.#]?)(\w+|\(\w+\))(.*)$/);if(t.assert(s,"The path string '"+n+"' is not well formed."),"#"===s[1])return this._addOperation(o,".(instance)."+s[2]+s[3],i);var a;return""===s[3]?(!function(t){r.deltas[s[2]]?r.compose(s[2],t):r.deltas[s[2]]=t}(t.applyConstructor(e.operations[o],i)),a=this.deltas[s[2]]):a=this.modify(s[2])._addOperation(o,s[3],i),"modify"===o?a:this},toString:function(){var e=void 0!==arguments[0]?arguments[0]:0,o=void 0!==arguments[1]?arguments[1]:"(root)",n=this,i=t.repeat(0+e,"    ");return i+"modify '"+o+"'\n"+Object.keys(this.deltas).map(function(t){return n.deltas[t].toString(e+1,t)}).join("\n")}}),this._defineStandardOperationTypes()},{get Delta(){return this.operations.modify},vp:function(){},newOperationType:function(e,o){var n=this;t.assert(!this.operations[e],"The '"+e+"' operation type already exists."),this.operations.modify.prototype[e]=function(t){for(var o=[],n=1;n<arguments.length;n++)o[n-1]=arguments[n];return this._addOperation(e,t,o)},this.compositions[e]={},Object.keys(this.compositions).forEach(function(o){t.assert(!n.compositions[o][e]),t.assert(!n.compositions[e][o]),n.compositions[o][e]=[],n.compositions[e][o]=[]}),this.operations[e]=t.newSubclass(this.operations.Delta,function(t){return function(){for(var e=[],o=0;o<arguments.length;o++)e[o]=arguments[o];t(),this.a=e}},{type:e,applyTo:o,toString:function(){var o=void 0!==arguments[0]?arguments[0]:0,n=void 0!==arguments[1]?arguments[1]:"(root)",i=t.repeat(0+o,"    ");return""+i+e+" '"+n+"': "+JSON.stringify(this.a).slice(1,-1)}})},newComposition:function(t,e,o){this.compositions[t][e].push(o)},_defineStandardOperationTypes:function(){function e(e){var o=void 0!==arguments[1]?arguments[1]:function(){return null};return"string"==typeof o&&(o=function(t){return function(e){return e[t]}}(o)),function(n,r,s){n.deltas[r]=t.applyConstructor(i.operations[e],[o({d1:n.deltas[r],d2:s,p1:n.deltas[r].a[0],p2:s.a[0]})])}}function o(e,o){t.assert(t.isDefined(e),"The operation '"+o+"' expects the property to be defined.")}function n(e,o){t.assert(t.isUndefined(e),"The operation '"+o+"' expects the property to be undefined.")}var i=this,r=function(t,e,o){throw new Error("You cannot follow '"+t[e].type+"' with '"+o.type+"'.")};this.newOperationType("add",function(t,e){n(t[e],"add"),t[e]=this.a[0]}),this.newOperationType("remove",function(t,e){o(t[e],"remove"),delete t[e]}),this.newOperationType("forbid",function(t,e){n(t[e],"forbid")}),this.newOperationType("replace",function(t,e){o(t[e],"replace"),t[e]=this.a[0]}),this.newComposition("modify","modify",function(t,e,o){Object.keys(o.deltas).forEach(function(n){t.compose(e,o.deltas[n])})}),this.newComposition("modify","add",r),this.newComposition("add","add",r),this.newComposition("add","modify",e("add",function(t){var e=t,o=e.d2,n=e.p1;return o.appliedTo(n)})),this.newComposition("modify","remove",e("remove")),this.newComposition("add","remove",e("forbid")),this.newComposition("remove","modify",r),this.newComposition("remove","add",e("replace","p2")),this.newComposition("remove","remove",r),this.newComposition("modify","forbid",r),this.newComposition("add","forbid",r),this.newComposition("remove","forbid",e("remove")),this.newComposition("forbid","modify",r),this.newComposition("forbid","add",e("add","p2")),this.newComposition("forbid","remove",r),this.newComposition("forbid","forbid",e("forbid")),this.newComposition("modify","replace",e("replace","p2")),this.newComposition("add","replace",e("add","p2")),this.newComposition("remove","replace",r),this.newComposition("forbid","replace",r),this.newComposition("replace","add",r),this.newComposition("replace","remove",e("remove")),this.newComposition("replace","forbid",r),this.newComposition("replace","modify",e("replace",function(t){var e=t,o=e.d2,n=e.p1;return o.appliedTo(n)})),this.newComposition("replace","replace",e("replace","p2"))}});return e}.apply(e,n),!(void 0!==i&&(t.exports=i))},function(t,e,o){var n;n=function(){"use strict";var t={newClass:function(t){var e=void 0!==arguments[1]?arguments[1]:{},o=t;return o.prototype=e,o.prototype.constructor=o,o},newSubclass:function(e,o){var n=void 0!==arguments[2]?arguments[2]:{},i=o(e.prototype.constructor);return i.prototype=Object.create(e.prototype),t.extend(i.prototype,n),i.prototype.constructor=i,i},extend:function(t){for(var e=[],o=1;o<arguments.length;o++)e[o-1]=arguments[o];return e.forEach(function(e){for(var o in e)e.hasOwnProperty(o)&&Object.defineProperty(t,o,Object.getOwnPropertyDescriptor(e,o))}),t},applyConstructor:function(t,e){var o=Object.create(t.prototype);return t.apply(o,e),o},assert:function(t,e){if(!t)throw new Error(e||"Assertion failed")},isUndefined:function(t){return"undefined"==typeof t},isDefined:function(t){return"undefined"!=typeof t},repeat:function(t,e){return new Array(t+1).join(e)}};return t}.call(e,o,e,t),!(void 0!==n&&(t.exports=n))}])});