!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("js-graph")):"function"==typeof define&&define.amd?define(["js-graph"],t):"object"==typeof exports?exports.DeltaModel=t(require("js-graph")):e.DeltaModel=t(e.JsGraph)}(this,function(e){return function(e){function t(n){if(o[n])return o[n].exports;var i=o[n]={exports:{},id:n,loaded:!1};return e[n].call(i.exports,i,i.exports,t),i.loaded=!0,i.exports}var o={};return t.m=e,t.c=o,t.p="",t(0)}([function(e,t,o){var n,i;n=[o(1),o(2)],i=function(e,t){"use strict";function o(e,o){t.assert("function"==typeof e,"The operation '"+o+"' expects the property it acts on to be a function.")}function n(e,o){t.assert(t.isDefined(e),"The operation '"+o+"' expects the property to be defined.")}function i(e,o){t.assert(t.isUndefined(e),"The operation '"+o+"' expects the property to be undefined.")}var r=function(){},a=function(e,t,o){e.operations[t]=o},s=function(e,t,o){o.applyTo(e.operations[t],"value")},p=t.newClass(function(){function f(e,o){_=!0,o===!0?g[e]=!0:o===!1||v[e]!==!0&&t.array(v,e).push(o)}function c(){if(_){_=!1;var e;do e=!1,m.eachVertex(function(o){g[o]||t.isUndefined(v[o])||v[o].some(function(e){return e.every(function(e){return g[e]})})&&(g[o]=!0,e=!0)});while(e)}}var d=this,l={},h=[];t.extend(this,{_addOperationType:function(e){var o=e,n=o.name,i=o.constructor,r=o.applyTo,a=o.prototype,s=o.method,p={};l[n]={name:n,Delta:i,method:p[n]},t.extend(l[n].Delta.prototype,a,{constructor:i,type:n,applyTo:r}),l.modify.Delta.prototype[n]=t.isDefined(s)?s:function(e){for(var t=[],o=1;o<arguments.length;o++)t[o-1]=arguments[o];return this._addOperation(l[n],e,t),this}},_addOperationAlias:function(e){var t=e,o=t.name,n=t.target,i=t.transform,r={};Object.defineProperty(r,o,{value:function(e){for(var t=[],o=1;o<arguments.length;o++)t[o-1]=arguments[o];return this._addOperation(l[n],e,i(t)),this}}),l[o]={name:o,method:r[o]},l.modify.Delta.prototype[o]=l[o].method},_addCompositionRule:function(e,t,o){h.push({op1Type:e,op2Type:t,composeFn:o})},_newDelta:function(e){for(var o=[],n=1;n<arguments.length;n++)o[n-1]=arguments[n];return t.applyConstructor(l[e].Delta,o)}});var y=this;this._addOperationType({name:"modify",constructor:function(e,o){var n=this;e=e||{},this.operations=o||{},Object.keys(e).forEach(function(o){var i=o.match(/^(\w+)\s+([\w\.]+)$/);if(i){var r=i[1],a=i[2];t.assert(r in l,"I don't know the '"+r+"' operation."),n[r](a,e[o])}})},applyTo:function(e,o){var n=this;t.isDefined(o)?(t.assert(t.isDefined(e[o]),"The 'modify' operation expects the property to be already defined."),Object.keys(this.operations).forEach(function(t){n.operations[t].applyTo(e[o],t)})):(t.assert(t.isDefined(e),"The 'modify' operation expects the property to be already defined."),Object.keys(this.operations).forEach(function(t){n.operations[t].applyTo(e,t)}))},prototype:{selectivelyApplyTo:function(e,o){t.assert(t.isDefined(e),"The 'modify' operation expects the property to be already defined."),t.isDefined(this.operations[o])&&this.operations[o].applyTo(e,o)},compose:function(e,o){var n=this;if(t.isUndefined(o))return this;var i;if(h.some(function(t){var r=t,a=r.op1Type,s=r.op2Type,p=r.composeFn;return n.operations[e].type===a&&o.type===s?(i=p,!0):void 0}),!i){var r=new Error("You cannot follow a '"+this.operations[e].type+"' operation "+("with a '"+o.type+"' operation on the same property."));throw r.op1=this.operations[e].type,r.op2=o.type,r}i(this,e,o)},_addOperation:function(e,o,n){var i=o.indexOf(".");if(-1!==i){var r=o.slice(0,i),a=o.slice(i+1),s=this._addOperation(l.modify,r);return s[e.name].apply(s,[a].concat(n))}var p=y._newDelta.apply(y,[e.name].concat(n));return this.operations.hasOwnProperty(o)&&t.isDefined(this.operations[o])?this.compose(o,p):this.operations[o]=p,this.operations[o]}},method:function(e,t){return this._addOperation(l.modify,e,[t])}}),this._addOperationType({name:"add",constructor:function(e){this.value=e},applyTo:function(e,t){i(e[t],"add"),e[t]=this.value}}),this._addOperationType({name:"replace",constructor:function(e){this.value=e},applyTo:function(e,t){n(e[t],"replace"),e[t]=this.value}}),this._addOperationType({name:"remove",constructor:function(){},applyTo:function(e,t){n(e[t],"remove"),delete e[t]}}),this._addOperationType({name:"forbid",constructor:function(){},applyTo:function(e,t){i(e[t],"forbid")}}),this._addCompositionRule("add","replace",function(e,t,o){e.operations[t]=p._newDelta("add",o.value)}),this._addCompositionRule("add","modify",s),this._addCompositionRule("add","remove",function(e,t){e.operations[t]=p._newDelta("forbid")}),this._addCompositionRule("replace","replace",a),this._addCompositionRule("replace","modify",s),this._addCompositionRule("replace","remove",a),this._addCompositionRule("modify","replace",a),this._addCompositionRule("modify","modify",function(e,t,o){Object.keys(o.operations).forEach(function(t){e.compose(t,o.operations[t])})}),this._addCompositionRule("modify","remove",a),this._addCompositionRule("remove","add",function(e,t,o){e.operations[t]=p._newDelta("replace",o.value)}),this._addCompositionRule("remove","forbid",r),this._addCompositionRule("forbid","add",a),this._addCompositionRule("forbid","forbid",r),this._addOperationType({name:"alter",constructor:function(e,t){this.value=e||[],this.alias=t||"alter"},applyTo:function(e,t){o(e[t],this.alias),this.value.forEach(function(o){var n=e[t],i=o.value;e[t]="prepend"===o.type?function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];i.apply(this,e),n.apply(this,e)}:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];n.apply(this,e),i.apply(this,e)}})}}),this._addCompositionRule("alter","alter",function(e,t,o){[].push.apply(e.operations[t].value,o.value)}),this._addCompositionRule("alter","replace",a),this._addCompositionRule("alter","remove",function(e,t){e.operations[t]=p._newDelta("forbid")}),this._addCompositionRule("add","alter",function(e,t,n){o(e.operations[t].value,n.alias),s(e,t,n)}),this._addCompositionRule("replace","alter",function(e,t,n){o(e.operations[t].value,n.alias),s(e,t,n)}),["prepend","insert","append"].forEach(function(e){d._addOperationAlias({name:e,target:"alter",transform:function(t){return[[{type:e,value:t[0]}],e]}})}),this._addOperationType({name:"after",constructor:function(e){t.assert("function"==typeof u,"Before creating an 'after' operation, you must register a promise resolver with delta.js."),this.value=e},applyTo:function(e,t){o(e[t],"after");var n=e[t],i=this.value;e[t]=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return u(n.apply(this,e)).then(function(){return i.apply(this,e)}.bind(this))}}}),this._addCompositionRule("after","replace",a),this._addCompositionRule("after","remove",a),this._addCompositionRule("add","after",function(e,t,n){o(e.operations[t].value,"after"),s(e,t,n)}),this._addCompositionRule("replace","after",function(e,t,n){o(e.operations[t].value,"after"),s(e,t,n)}),this._addCompositionRule("insert","after",s),this._addCompositionRule("after","insert",s);var m=new e;t.extend(this,{graph:function(){return m}});var v={},g={},_=!1;this.Delta=t.newSubclass(l.modify.Delta,function(e,o,n){e.call(this,n),t.assert(n instanceof Object,"A delta should be given as an object."),l.modify.Delta.apply(this,n),Object.defineProperties(this,{name:{get:function(){return o}},manuallySelectable:{get:function(){return t.isDefined(n.manuallySelectable)?!!n.manuallySelectable:t.isDefined(n.resolves)&&n.resolves.length>0?!1:!0}},selected:{get:function(){return c(),!!g[o]}},"if":{get:function(){return n["if"]===!0||n["if"]===!1?n["if"]:n["if"]||n.iff||n.resolves?[].concat(n["if"]||[],n.iff||[],n.resolves||[]):!1}},onlyIf:{get:function(){return n.onlyIf===!0||n.onlyIf===!1?n.onlyIf:n.onlyIf||n.iff||n.expects||n.resolves?[].concat(n.onlyIf||[],n.iff||[],n.expects||[],n.resolves||[]):!0}},after:{get:function(){return[].concat(n.after||[],n.expects||[],n.resolves||[],n.requires||[])}},selects:{get:function(){return[].concat(n.selects||[],n.requires||[])}}}),_=!0,t.isDefined(this.if)&&f(o,this.if),this.selects.forEach(function(e){f(e,[o])}),m.addVertex(o,this),this.after.forEach(function(e){m.createEdge(e,o)}),t.assert(!m.hasCycle(),"The delta "+o+" introduced a cycle in the application order.")}),t.extend(this,{select:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];e.forEach(function(e){f(e,!0)})},vp:function(e,o){var n={};return n[e]=o,c(),m.eachVertex(function(e,o){t.assert(!o.selected||o.onlyIf===!0||o.onlyIf.every(function(e){return m.vertexValue(e).selected}),"The 'onlyIf' condition of delta '"+o.name+"' was violated.")}),m.topologically(function(t,o){o.selected&&o.selectivelyApplyTo(n,e)}),n[e]}})}),u=null;return t.extend(p,{registerPromiseResolver:function(e){u=e}}),p}.apply(t,n),!(void 0!==i&&(e.exports=i))},function(t){t.exports=e},function(e,t,o){var n;n=function(){"use strict";var e={newClass:function(e,t){t=t||{};var o=function(){for(var t=[],o=0;o<arguments.length;o++)t[o]=arguments[o];e.apply(this,t)};return o.prototype=t,o.prototype.constructor=o,o},newSubclass:function(e,t,o){o=o||{};var n=function(){for(var o=[],n=0;n<arguments.length;n++)o[n]=arguments[n];t.apply(this,[e.prototype.constructor].concat(o))};return n.prototype=Object.create(e.prototype,o),n.prototype.constructor=n,n},extend:function(e){for(var t=[],o=1;o<arguments.length;o++)t[o-1]=arguments[o];return t.forEach(function(t){for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o])}),e},array:function(t,o){return e.isUndefined(t[o])&&(t[o]=[]),t[o]},bindA:function(e,t,o){return e.bind.apply(e,[t].concat(o))},bind:function(t,o){for(var n=[],i=2;i<arguments.length;i++)n[i-2]=arguments[i];return e.bindA(t[o],t,n)},applyConstructor:function(e,t){var o=e.bind.apply(e,[null].concat(t));return new o},assert:function(e,t){if(!e)throw new Error(t||"Assertion failed")},isUndefined:function(e){return"undefined"==typeof e},isDefined:function(e){return"undefined"!=typeof e}};return e}.call(t,o,t,e),!(void 0!==n&&(e.exports=n))}])});