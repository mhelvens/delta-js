!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e(require("js-graph")):"function"==typeof define&&define.amd?define(["js-graph"],e):"object"==typeof exports?exports.DeltaJs=e(require("js-graph")):t.DeltaJs=e(t.JsGraph)}(this,function(t){return function(t){function e(o){if(n[o])return n[o].exports;var r=n[o]={exports:{},id:o,loaded:!1};return t[o].call(r.exports,r,r.exports,e),r.loaded=!0,r.exports}var n={};return e.m=t,e.c=n,e.p="",e(0)}([function(t,e,n){var o,r;o=[n(2),n(1)],r=function(t){"use strict";function e(t,e){return new r(t,e)}var n=t.newClass(function(){var n=this,o=this;this.operations={},this.compositions=[],this._onNewOperationTypeListeners=[];var r=this.Delta=t.newClass(function(e,n){this.arg=e,this.meta=t.extend({},n||{})},{clone:function(){return new this.constructor(this.arg,this.meta)},appliedTo:function(t){"function"==typeof t.clone&&(t=t.clone());var n={value:t};return this.applyTo(e(n,"value")),n.value},compose:function(e){var n,r=this;return o.compositions.some(function(t){var o=t,i=o.precondition,a=o.compose;return i(r,e)?(n=a,!0):void 0}),t.assert("function"==typeof n,"A '"+this.type+"' operation cannot be followed by a '"+e.type+"' operation."),n(this,e)},toString:function(){var e=void 0!==arguments[0]?arguments[0]:0,n=void 0!==arguments[1]?arguments[1]:"(root)",o=t.repeat(e,"    "),r=""+o+this.type;return n&&(r+=" '"+n+"'"),t.isDefined(this.arg)&&(r+=": "+JSON.stringify(this.arg)),r},_createOperationInterface:function(){var e={};return n.onNewOperationType(function(n){n.meta.methods.forEach(function(n){t.isUndefined(e[n])&&(e[n]=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var o=this._applyOperationMethod(n,t);return o.operations||this})})}),function(t){Object.defineProperty(this,"operations",{value:Object.create(e,{_applyOperationMethod:{value:t},delta:{value:this}})})}}()});this.overloads={};var i=this.operations.OverloadedDelta=t.newSubclass(this.Delta,function(t){return function(e,n){t.call(this,e,n),this.overloads=[]}},{clone:function(){var t=o.Delta.prototype.clone.call(this,this.arg,this.meta);return t.overloads=this.overloads.map(function(t){return t.clone()}),t},applyTo:function(t){var e=[],n=this.overloads.some(function(n){var r=o._evaluatePrecondition(n,t);return r!==!0?(e.push(r),!1):(n.applyTo(t),!0)});if(!n)throw 0===e.length?new Error("This overloaded delta has no overloads, so cannot apply to the value: "+t.value):1===e.length?e[0]:new Error("None of the delta types "+this.type.join(",")+" "+("apply to the value: "+t.value+"\n")+e.map(function(t){return t.message}).join("\n"))},toString:function(){var t=void 0!==arguments[0]?arguments[0]:0,e=void 0!==arguments[1]?arguments[1]:"(root)",n=r.prototype.toString.call(this,t,e);return n+="\n"+this.overloads.map(function(e){return e.toString(t+1,null)}).join("\n")}});i.type=i.prototype.type="OverloadedDelta",i.meta=i.prototype.meta={methods:[]},this.newComposition(function(t,e){return t instanceof i||e instanceof i},function(t,e){var n=t instanceof i?t.overloads:[t],o=e instanceof i?e.overloads:[e],r=new i,a=[];if(n.forEach(function(t){o.forEach(function(e){try{r.overloads.push(t.compose(e))}catch(n){a.push(n)}})}),0===r.overloads.length)throw new Error(a.map(function(t){return t.message}).join("\n"));return r});var a=this.operations.Modify=t.newSubclass(this.Delta,function(t){return function(e,n){var r=this;t.call(this,e,n),this.deltas={},this._createOperationInterface(function(t,e){var n=e,i=n[0],a=n[1],s=o._processOptions(i),u=o._getDeltaByMethod(t,a),p=r._addOperation(s,u);return p.operations?p:u})}},{clone:function(){var t=this,e=o.Delta.prototype.clone.call(this,this.arg,this.meta);return Object.keys(this.deltas).forEach(function(n){e.deltas[n]=t.deltas[n].clone()}),e},precondition:function(t){return t.value instanceof Object},applyTo:function(n){var o=this;t.assert(t.isUndefined(this.meta.target),"Targeted deltas cannot be applied to anything manually."),t.assert(t.isDefined(n.value),"The 'Modify' operation expects the property to be defined."),t.assert(n.value instanceof Object,"The 'Modify' operation expects the property to be an Object."),Object.keys(this.deltas).forEach(function(t){o.deltas[t].applyTo(e(n.value,t))})},toString:function(){var t=void 0!==arguments[0]?arguments[0]:0,e=void 0!==arguments[1]?arguments[1]:"(root)",n=this,o=r.prototype.toString.call(this,t,e);return Object.keys(this.deltas).length>0&&(o+="\n"+Object.keys(this.deltas).map(function(e){return n.deltas[e].toString(t+1,e)}).join("\n")),o},_addOperation:function(n,r){var i=o._parsePath(n.path),s=i.lead,u=i.prop,p=i.rest;if("#"===s)return this._addOperation(t.extend({},n,{path:".(instance)."+u+p}),r);if(p.length>0)return this.operations.modify(u).delta._addOperation(t.extend({},n,{path:p}),r);if(t.isDefined(this.meta.target))return"Modify"===r.type?new a(void 0,t.extend({},r.meta,{target:this.meta.target.chain(u)})):(r.applyTo(this.meta.target.chain(u)),this);if(t.isDefined(this.deltas[u])){var c=this.deltas[u]=this.deltas[u].compose(r);if("Modify"===r.type&&"Modify"!==c.type)return new a(void 0,t.extend({},r.meta,{target:e(c,"arg")}))}else this.deltas[u]=r;return this.deltas[u]}});a.type=a.prototype.type="Modify",a.meta=a.prototype.meta={methods:["modify"]},this._onNewOperationTypeListeners.forEach(function(t){t(a)}),Array.isArray(this.overloads.modify)||(this.overloads.modify=[]),this.overloads.modify.push("Modify"),this._defineStandardOperationTypes()},{_parsePath:function(e){var n=e.match(/^([.#]?)(\w+|\(\w+\))(.*)$/);t.assert(n,"The path string '"+e+"' is not well formed.");var o=n,r=o[1],i=o[2],a=o[3];return{lead:r,prop:i,rest:a}},_processOptions:function(t){if("string"==typeof t)return{path:t};if(t instanceof Object)return t;throw new Error("The options argument on a delta operation a should be a path string or an options object.")},_getDeltaByMethod:function(t,e){var n=this,o=this.overloads[t].map(function(o){return new n.operations[o](e,{method:t})});if(1===o.length)return o[0];var r=new this.operations.OverloadedDelta(e,{method:t});return r.overloads=o,r},_evaluatePrecondition:function(t,e){if("function"==typeof t.precondition){var n=t.precondition(e);if(n instanceof Error)return n;if("string"==typeof n)return new TypeError(n);if(!n)return new TypeError("The value '"+e.value+"' does not satisfy "+("the precondition of the '"+name+"' operation."))}return!0},newOperationType:function(e,n){var o=n,r=o.construct,i=o.precondition,a=o.applyTo,s=o.methods,u=o.clone,p=void 0!==arguments[2]?arguments[2]:{},c=this,l=this;t.assert(!this.operations[e],"The '"+e+"' operation type already exists.");var f=this.operations[e]=t.newSubclass(this.Delta,function(t){return function(e,n){t.call(this,e,n),r&&r.call(this)}},t.extend({precondition:i,applyTo:function(e){var n=l._evaluatePrecondition(this,e);if(n!==!0)throw n;t.isDefined(a)&&a.call(this,e)}},p));return f.type=f.prototype.type=e,f.meta=f.prototype.meta={methods:s||[e[0].toLowerCase()+e.slice(1)]},t.isDefined(u)&&(f.prototype.clone=u),f.meta.methods.forEach(function(t){Array.isArray(c.overloads[t])||(c.overloads[t]=[]),c.overloads[t].push(e)}),this._onNewOperationTypeListeners.forEach(function(t){t(f)}),f},onNewOperationType:function(t){var e=this;this._onNewOperationTypeListeners.push(t),Object.keys(this.operations).forEach(function(n){t(e.operations[n])})},newComposition:function(t,e){this.compositions.push({precondition:t,compose:e})},_defineStandardOperationTypes:function(){function e(t,e){return function(n,o){return n.type===t&&o.type===e}}function n(t){var e=void 0!==arguments[1]?arguments[1]:null;return"string"==typeof e&&(e=function(t){return function(e){return e[t]}}(e)),e?function(n,r){return new o.operations[t](e({d1:n,d2:r,p1:n.arg,p2:r.arg}))}:function(){return new o.operations[t]}}var o=this;this.newOperationType("Add",{precondition:function(e){return e instanceof r&&t.isUndefined(e.value)},applyTo:function(t){t.value=this.arg}}),this.newOperationType("Remove",{precondition:function(e){return e instanceof r&&t.isDefined(e.value)},applyTo:function(t){t.delete()}}),this.newOperationType("Forbid",{precondition:function(e){return t.isUndefined(e.value)}}),this.newOperationType("Replace",{precondition:function(e){return e instanceof r&&t.isDefined(e.value)},applyTo:function(t){t.value=this.arg}}),this.newComposition(e("Modify","Modify"),function(t,e){var n=t.clone();return Object.keys(e.deltas).forEach(function(t){n.deltas[t].compose(e.deltas[t])}),n}),this.newComposition(e("Add","Modify"),n("Add",function(t){var e=t,n=e.d2,o=e.p1;return n.appliedTo(o)})),this.newComposition(e("Modify","Remove"),n("Remove")),this.newComposition(e("Add","Remove"),n("Forbid")),this.newComposition(e("Remove","Add"),n("Replace",function(t){var e=t.p2;return e})),this.newComposition(e("Remove","Forbid"),n("Remove")),this.newComposition(e("Forbid","Add"),n("Add",function(t){var e=t.p2;return e})),this.newComposition(e("Forbid","Forbid"),n("Forbid")),this.newComposition(e("Modify","Replace"),n("Replace",function(t){var e=t.p2;return e})),this.newComposition(e("Add","Replace"),n("Add",function(t){var e=t.p2;return e})),this.newComposition(e("Replace","Modify"),n("Replace",function(t){var e=t,n=e.d2,o=e.p1;return n.appliedTo(o)})),this.newComposition(e("Replace","Remove"),n("Remove")),this.newComposition(e("Replace","Replace"),n("Replace",function(t){var e=t.p2;return e})),this.newOperationType("PutIntoArray",{construct:function(){this.values=this.meta.method?[{method:this.meta.method,value:this.arg}]:[]},clone:function(){var t=o.Delta.prototype.clone.call(this,this.arg,this.meta);return t.values=[],this.values.forEach(function(e){t.values.push(e)}),t},precondition:function(e){return t.isDefined(e.value)&&Array.isArray(e.value)},applyTo:function(t){var e=t.value;this.values.forEach(function(t){var n=t,o=n.method,r=n.value;switch(o){case"prepend":e.unshift(r);break;case"insert":var i=Math.floor(Math.random()*(e.length+1));e.splice(i,0,r);break;case"append":e.push(r)}})},methods:["prepend","insert","append"]}),this.newComposition(e("Add","PutIntoArray"),n("Add",function(t){var e=t,n=e.d2,o=e.p1;return n.appliedTo(o)})),this.newComposition(e("Replace","PutIntoArray"),n("Replace",function(t){var e=t,n=e.d2,o=e.p1;return n.appliedTo(o)})),this.newComposition(e("PutIntoArray","Remove"),n("Remove")),this.newComposition(e("PutIntoArray","Replace"),n("Replace",function(t){var e=t.p2;return e})),this.newComposition(e("PutIntoArray","PutIntoArray"),function(t,e){var n=new o.operations.PutIntoArray;return n.values=t.values.concat(e.values),n}),this.newOperationType("PutIntoFunction",{construct:function(){this.values=this.meta.method?[{method:this.meta.method,value:this.arg}]:[]},clone:function(){var t=o.Delta.prototype.clone.call(this,this.arg,this.meta);return t.values=[],this.values.forEach(function(e){t.values.push(e)}),t},precondition:function(e){return t.isDefined(e.value)&&"function"==typeof e.value&&(t.isDefined(e.value._DeltaJs_functions)||e instanceof r)},applyTo:function(e){if(t.isUndefined(e.value._DeltaJs_functions)){var n=e.value,o=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n,r=this;return o._DeltaJs_functions.forEach(function(e){n=e.apply(r,t)}),n};o._DeltaJs_functions=[function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];n.apply(this,t)}],e.value=o}var r=e.value._DeltaJs_functions;this.values.forEach(function(t){var e=t,n=e.method,o=e.value;switch(n){case"prepend":r.unshift(o);break;case"insert":var i=Math.floor(Math.random()*(r.length+1));r.splice(i,0,o);break;case"append":r.push(o)}})},methods:["prepend","insert","append"]}),this.newComposition(e("Add","PutIntoFunction"),n("Add",function(t){var e=t,n=e.d2,o=e.p1;return n.appliedTo(o)})),this.newComposition(e("Replace","PutIntoFunction"),n("Replace",function(t){var e=t,n=e.d2,o=e.p1;return n.appliedTo(o)})),this.newComposition(e("PutIntoFunction","Remove"),n("Remove")),this.newComposition(e("PutIntoFunction","Replace"),n("Replace",function(t){var e=t.p2;return e})),this.newComposition(e("PutIntoFunction","PutIntoFunction"),function(t,e){var n=new o.operations.PutIntoFunction;return n.values=t.values.concat(e.values),n})}}),o=n.ReadableTarget=t.newClass(function(t){this._val=t},{getValue:function(){return this._val},get value(){return this.getValue()},set value(t){this.setValue(t)},chain:function(e){return t.assert(this.value instanceof Object,"The ReadableTarget.prototype.chain method expects the target value to be an Object."),new r(this.value,e)}}),r=n.WritableTarget=t.newSubclass(o,function(){return function(t,e){this._obj=t,this._prop=e}},{getValue:function(){return this._obj[this._prop]},setValue:function(t){this._obj[this._prop]=t},"delete":function(){delete this._obj[this._prop]}});return n}.apply(e,o),!(void 0!==r&&(t.exports=r))},function(e){e.exports=t},function(t,e,n){var o;o=function(){"use strict";var t={newClass:function(){var t=void 0!==arguments[0]?arguments[0]:{},e=void 0!==arguments[1]?arguments[1]:{};"function"!=typeof t&&(e=t,t=function(){});var n=t;return n.prototype=e,n.prototype.constructor=n,n},newSubclass:function(e){var n=void 0!==arguments[1]?arguments[1]:{},o=void 0!==arguments[2]?arguments[2]:{};"function"!=typeof n&&(o=n,n=function(t){return function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];t.apply(this,e)}});var r=n(e.prototype.constructor);return r.prototype=Object.create(e.prototype),t.extend(r.prototype,o),r.prototype.constructor=r,r},extend:function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];return e.forEach(function(e){for(var n in e)e.hasOwnProperty(n)&&Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(e,n))}),t},applyConstructor:function(t,e){var n=Object.create(t.prototype);return t.apply(n,e),n},assert:function(t,e){if(!t)throw new Error(e||"Assertion failed")},isUndefined:function(t){return"undefined"==typeof t},isDefined:function(t){return"undefined"!=typeof t},repeat:function(t,e){return new Array(t+1).join(e)}};return t}.call(e,n,e,t),!(void 0!==o&&(t.exports=o))}])});